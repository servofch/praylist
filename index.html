<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>今日の祈り</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display" rel="stylesheet">
    <style>
        body { 
            font-family: 'Noto Sans JP', sans-serif; 
            background-color: #f0f2f5;
        }
        #main-app {
            width: 100%;
            min-height: 100vh;
            overflow-x: hidden;
        }
        .screen { flex-grow: 1; }
        .hidden { display: none; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .requests-content { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out, margin-top 0.5s ease-in-out; margin-top: 0; }
        .expanded .requests-content { max-height: 500px; margin-top: 1rem; }
        
        /* ★ 追加: グループヘッダーのchevron回転 */
        .group-header .group-chevron {
            transition: transform 0.3s ease-in-out;
        }
        .group-header.expanded .group-chevron {
            transform: rotate(180deg);
        }

        /* ★ 変更: グループリストの折りたたみスタイル */
        .group-people-list { 
            max-height: 0; 
            overflow: hidden; 
            transition: max-height 0.5s ease-in-out, margin-top 0.5s ease-in-out; 
            margin-top: 0; 
        }
        .group-header.expanded + .group-people-list { 
            max-height: 2000px; /* 十分な高さを確保 */
            margin-top: 0.5rem; /* space-y-2 と合わせる */
        }


        .list-item-content { transition: transform 0.3s ease-out; position: relative; z-index: 10; background-color: white; }
        .list-item-content.swiped { transform: translateX(-96px); }

        /* Drag and Drop Styles */
        .dragging { opacity: 0.5; }
        .drag-over { border-top: 2px solid #3b82f6; }

        /* ★ 追加: カレンダー用スタイル */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }
        .calendar-day {
            text-align: center;
            padding: 8px 4px;
            border-radius: 9999px; /* full circle */
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: auto;
        }
        .calendar-day:hover {
            background-color: #f3f4f6; /* gray-100 */
        }
        .calendar-day.other-month {
            color: #9ca3af; /* gray-400 */
            cursor: default;
            pointer-events: none;
        }
        .calendar-day.today {
            font-weight: bold;
            background-color: #dbeafe; /* blue-100 */
            color: #1d4ed8; /* blue-700 */
        }
        /* ★ 変更: 日付範囲選択ハイライトを削除 */
        
        .calendar-day.has-event::after {
            content: '';
            position: absolute;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 6px;
            border-radius: 9999px;
            background-color: #f97316; /* orange-500 */
        }
        
        /* ★ 追加: 年/月ピッカー用スタイル */
        .month-picker-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
        }
        .month-picker-button {
            padding: 0.75rem 0.5rem;
            text-align: center;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
            font-weight: 500;
        }
        .month-picker-button:hover {
            background-color: #f3f4f6; /* gray-100 */
        }
        .month-picker-button.selected {
            background-color: #dbeafe; /* blue-100 */
            color: #1d4ed8; /* blue-700 */
        }


        /* ★ 追加: ホーム画面の祈り項目スタイル */
        .prayer-item {
            /* ★ 変更: p-4 を削除 (子要素でパディングを制御) */
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            /* ★ 変更: cursor: pointer を削除 (子要素で制御) */
            transition: background-color 0.2s ease-in-out;
        }
        .prayer-item .requests-content hr { margin-top: 0.5rem; margin-bottom: 0.5rem; }

        /* Cycle (Blue) */
        .prayer-item-cycle {
            background-color: #eff6ff; /* blue-50 */
        }
        .prayer-item-cycle:hover {
            background-color: #dbeafe; /* blue-100 */
        }
        .prayer-item-cycle .prayer-name {
            color: #1e40af; /* blue-800 */
        }
        .prayer-item-cycle .prayer-chevron {
            color: #3b82f6; /* blue-500 */
        }
        .prayer-item-cycle .requests-content {
             /* ★ 変更: p-4 pt-0 を .list-item-content の方へ移動 */
        }
        .prayer-item-cycle .requests-content hr {
            border-color: #bfdbfe; /* blue-200 */
        }

        /* Calendar (Yellow-ish) */
        .prayer-item-calendar {
            background-color: #fefce8; /* yellow-50 */
        }
        .prayer-item-calendar:hover {
            background-color: #fef9c3; /* yellow-100 */
        }
        .prayer-item-calendar .prayer-name {
            color: #854d0e; /* yellow-800 */
        }
        .prayer-item-calendar .prayer-chevron {
            color: #ca8a04; /* yellow-500 */
        }
        .prayer-item-calendar .requests-content {
             /* ★ 変更: p-4 pt-0 を .list-item-content の方へ移動 */
        }
        .prayer-item-calendar .requests-content hr {
            border-color: #fde68a; /* yellow-200 */
        }
    </style>
</head>
<body>

    <div id="main-app" class="w-full min-h-screen flex flex-col max-w-lg mx-auto bg-gray-50 shadow-lg relative">
        <header class="bg-white/80 backdrop-blur-sm shadow-md sticky top-0 z-20 flex-shrink-0">
            <div class="relative flex justify-center items-center p-4 h-16">
                <div class="absolute left-4">
                    <button id="menu-button" class="p-2 rounded-full hover:bg-gray-200 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                    </button>
                </div>
                <h1 id="header-title" class="text-xl font-bold text-gray-900 cursor-pointer">Praylist</h1>
            </div>
        </header>
        
        <!-- ★ 変更: flex-grow を削除し、コンテンツの高さがそのままページに反映されるようにします -->
        <div class="phone-content">
            <!-- ホーム画面 -->
            <main id="home-screen" class="screen p-4">
                <div class="fade-in bg-white rounded-2xl shadow-lg p-6 text-center">
                    <p id="current-date" class="text-sm text-gray-500 mb-4"></p>
                    <h2 class="text-2xl font-bold text-gray-900 mb-4">今日の祈り</h2>
                    <hr class="border-gray-300 my-4">
                    <div id="prayer-list-container" class="space-y-3 text-left"></div>
            </div>
        </main>
            <!-- リスト一覧画面 -->
            <!-- ★ 変更: flex flex-col を削除 -->
            <div id="list-screen" class="screen hidden p-4">
                <div class="mb-4">
                    <input type="search" id="search-input" placeholder="名前か祈祷課題で検索..." class="w-full p-3 border rounded-lg">
                </div>
                <!-- ★ 変更: flex-grow と overflow-y-auto を削除し、代わりに mb-24 (FABを避けるためのマージン) を追加 -->
                <div id="all-people-list" class="space-y-4 mb-24"></div>
            </div>
             <!-- Pray Cycle画面 -->
            <!-- ★ 変更: flex flex-col を削除 -->
            <div id="pray-cycle-screen" class="screen hidden p-4">
                <!-- ★ 変更: flex-grow と overflow-y-auto を削除 -->
                <div id="pray-cycle-list" class="space-y-4"></div>
            </div>
            <!-- ★ 変更: Pray Calendar画面 (検索バーと月間一覧を追加) -->
            <div id="calendar-screen" class="screen hidden p-4 space-y-4">
                
                <!-- ★ 削除: カレンダー検索バー -->
                <!-- 
                <div class="bg-white p-3 rounded-2xl shadow-lg">
                    <input type="search" id="calendar-search-input" placeholder="名前か祈祷課題で検索..." class="w-full p-3 border rounded-lg">
                </div>
                 -->

                <!-- カレンダー本体 -->
                <div class="bg-white p-4 rounded-2xl shadow-lg">
                    <!-- カレンダーヘッダー -->
                    <div class="flex justify-between items-center mb-4">
                        <button id="prev-month-button" class="p-2 rounded-full hover:bg-gray-100 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                        </button>
                        <!-- ★ 変更: h2 を button に変更 -->
                        <button id="calendar-month-year" class="text-xl font-bold p-2 hover:bg-gray-100 rounded-lg transition"></button>
                        <button id="next-month-button" class="p-2 rounded-full hover:bg-gray-100 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                        </button>
                    </div>
                    <!-- 曜日 -->
                    <div class="calendar-grid mb-2">
                        <div class="text-center font-medium text-sm text-red-500">日</div>
                        <div class="text-center font-medium text-sm">月</div>
                        <div class="text-center font-medium text-sm">火</div>
                        <div class="text-center font-medium text-sm">水</div>
                        <div class="text-center font-medium text-sm">木</div>
                        <div class="text-center font-medium text-sm">金</div>
                        <div class="text-center font-medium text-sm text-blue-500">土</div>
                    </div>
                    <!-- 日付グリッド -->
                    <div id="calendar-grid" class="calendar-grid">
                        <!-- JSで生成されます -->
                    </div>
                </div>

                <!-- ★ 変更: 今月の予定一覧 -->
                <div class="bg-white p-4 rounded-2xl shadow-lg">
                    <!-- ★ 変更: タイトルを「今月の祈り」に変更 -->
                    <h2 class="text-xl font-bold mb-3 text-gray-800">今月の祈り</h2>
                    <div id="calendar-monthly-list" class="space-y-3">
                        <!-- JSで生成されます -->
                    </div>
                </div>
            </div>
            <!-- 設定画面 -->
            <div id="settings-screen" class="screen hidden p-4">
                <div class="space-y-6">
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <label for="start-date-input" class="block text-lg font-bold text-gray-800 mb-2">開始日の設定</label>
                        <input type="date" id="start-date-input" class="w-full p-3 border rounded-lg">
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <label for="cycle-period-input" class="block text-lg font-bold text-gray-800 mb-2">周期の設定（日数）</label>
                        <input type="number" id="cycle-period-input" min="1" class="w-full p-3 border rounded-lg">
                    </div>
                    <button id="save-settings-button" class="w-full bg-blue-500 text-white font-bold py-4 rounded-lg">設定を保存</button>
                </div>
            </div>
        </div>

        <!-- ★ 変更: FABコンテナの配置場所と方法を変更 -->
        <!-- 'fixed' を使いビューポート基準で配置し、親コンテナ(#main-app)の幅と中央揃えに合わせる -->
        <!-- 
            1. ビューポート(画面)に対して 'fixed' で固定します。
            2. 'w-full max-w-lg' と 'left: 50%; transform: translateX(-50%);' で、
               #main-app と同じ幅・同じ中央揃えのコンテナを作成します。
            3. 'pointer-events-none' でラッパー自体はクリックできないようにします。
        -->
        <div class="fixed bottom-6 z-20 w-full max-w-lg" style="left: 50%; transform: translateX(-50%); pointer-events: none;">
            <!-- 
                1. 実際のボタンコンテナを 'float-right' で右端に寄せます。
                2. 'mr-6' で右側の余白を調整します。
                3. 'pointer-events-auto' でボタンはクリックできるように戻します。
            -->
            <div id="fab-container" class="flex flex-col gap-4 mr-6 float-right hidden" style="pointer-events: auto;">
                <button id="add-group-fab" class="w-14 h-14 bg-green-500 text-white rounded-full flex items-center justify-center shadow-lg hover:bg-green-600 transition">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                       <path stroke-linecap="round" stroke-linejoin="round" d="M5 19a2 2 0 01-2-2V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1M5 19h14a2 2 0 002-2v-5a2 2 0 00-2-2H9a2 2 0 00-2 2v5a2 2 0 01-2 2z" />
                     </svg>
                </button>
                <button id="add-person-fab" class="w-14 h-14 bg-blue-500 text-white rounded-full flex items-center justify-center shadow-lg hover:bg-blue-600 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                </button>
            </div>
        </div>
        <!-- ★ 変更ここまで -->


        <!-- サイドメニュー -->
        <div id="menu-drawer" class="fixed inset-0 z-30 transform -translate-x-full transition-transform duration-300">
            <div id="menu-overlay" class="absolute inset-0 bg-black/50"></div>
            <div class="relative w-64 h-full bg-white shadow-xl p-4">
                <h2 class="text-xl font-bold mb-6">メニュー</h2>
                <ul class="space-y-2">
                    <li><a href="#" data-screen="home-screen" class="menu-item block p-3 hover:bg-gray-100 rounded">戻る</a></li>
                    <li><a href="#" data-screen="list-screen" class="menu-item block p-3 hover:bg-gray-100 rounded">Praylist</a></li>
                    <li><a href="#" data-screen="pray-cycle-screen" class="menu-item block p-3 hover:bg-gray-100 rounded">Pray Cycle</a></li>
                    <!-- ★ 追加: カレンダーへのリンク -->
                    <li><a href="#" data-screen="calendar-screen" class="menu-item block p-3 hover:bg-gray-100 rounded">Pray Calender</a></li>
                    <li><a href="#" data-screen="settings-screen" class="menu-item block p-3 hover:bg-gray-100 rounded">設定</a></li>
                </ul>
            </div>
        </div>

        <!-- 祈る相手 詳細・編集モーダル -->
        <div id="person-modal" class="fixed inset-0 bg-black/60 z-40 items-center justify-center p-4 hidden">
            <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm">
                <!-- ★ 変更点：名前をh3からinputに変更 -->
                <div class="mb-4">
                    <label for="person-modal-name-input" class="block text-sm font-medium text-gray-700 mb-1">名前</label>
                    <input type="text" id="person-modal-name-input" class="w-full p-3 border rounded-lg text-lg font-bold text-center" placeholder="名前">
                </div>
                <div class="mb-4">
                    <label for="person-modal-group" class="block text-sm font-medium text-gray-700 mb-1">グループ</label>
                    <select id="person-modal-group" class="w-full p-2 border rounded-lg bg-white"></select>
                </div>
                <textarea id="person-modal-requests" class="w-full h-40 p-3 border rounded-lg mb-4" placeholder="祈祷課題..."></textarea>
                <div class="flex gap-2">
                    <button id="person-modal-close" class="w-full py-3 bg-gray-200 rounded-lg">閉じる</button>
                    <button id="person-modal-save" class="w-full py-3 bg-blue-500 text-white rounded-lg">保存</button>
                </div>
            </div>
        </div>
        
        <!-- 祈る相手 追加モーダル -->
        <div id="add-person-modal" class="fixed inset-0 bg-black/60 z-40 items-center justify-center p-4 hidden">
            <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm">
                <h3 class="text-2xl font-bold mb-4 text-center">祈る相手を追加</h3>
                <!-- ★ 変更：フォームの構成を詳細化 -->
                <form id="add-person-modal-form">
                    <!-- 名前 -->
                    <div class="mb-4">
                        <label for="new-person-modal-name" class="block text-sm font-medium text-gray-700 mb-1">名前</label>
                        <input type="text" id="new-person-modal-name" placeholder="名前を入力" class="w-full p-3 border rounded-lg" required>
                    </div>
                    <!-- グループ -->
                    <div class="mb-4">
                        <label for="new-person-modal-group" class="block text-sm font-medium text-gray-700 mb-1">グループ</label>
                        <select id="new-person-modal-group" class="w-full p-3 border rounded-lg bg-white"></select>
                    </div>
                    <!-- 祈祷課題 -->
                    <div class="mb-4">
                        <label for="new-person-modal-requests" class="block text-sm font-medium text-gray-700 mb-1">祈祷課題</label>
                        <textarea id="new-person-modal-requests" class="w-full h-32 p-3 border rounded-lg" placeholder="祈祷課題..."></textarea>
                    </div>
                    <!-- ボタン -->
                    <div class="flex gap-2">
                        <button type="button" id="add-person-modal-close" class="w-full py-3 bg-gray-200 rounded-lg">キャンセル</button>
                        <button type="submit" class="w-full py-3 bg-blue-500 text-white rounded-lg">追加</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- ★ 修正: 欠落していた「グループ追加モーダル」のHTMLを追加 -->
        <div id="add-group-modal" class="fixed inset-0 bg-black/60 z-40 items-center justify-center p-4 hidden">
            <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm">
                <h3 class="text-2xl font-bold mb-4 text-center">グループを追加</h3>
                <form id="add-group-modal-form">
                    <div class="mb-4">
                        <label for="new-group-modal-input" class="block text-sm font-medium text-gray-700 mb-1">グループ名</label>
                        <input type="text" id="new-group-modal-input" placeholder="グループ名を入力" class="w-full p-3 border rounded-lg" required>
                    </div>
                    <div class="flex gap-2">
                        <button type="button" id="add-group-modal-close" class="w-full py-3 bg-gray-200 rounded-lg">キャンセル</button>
                        <button type="submit" class="w-full py-3 bg-blue-500 text-white rounded-lg">追加</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- ★ 修正: 欠落していた「グループ編集モーダル」のHTMLを追加 -->
        <div id="edit-group-modal" class="fixed inset-0 bg-black/60 z-40 items-center justify-center p-4 hidden">
            <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm">
                <h3 class="text-2xl font-bold mb-4 text-center">グループを編集</h3>
                <form id="edit-group-modal-form">
                    <div class="mb-4">
                        <label for="edit-group-modal-input" class="block text-sm font-medium text-gray-700 mb-1">グループ名</label>
                        <input type="text" id="edit-group-modal-input" class="w-full p-3 border rounded-lg" required>
                    </div>
                    <div class="flex gap-2 mb-4">
                        <button type="button" id="edit-group-modal-close" class="w-full py-3 bg-gray-200 rounded-lg">キャンセル</button>
                        <button type="submit" class="w-full py-3 bg-blue-500 text-white rounded-lg">保存</button>
                    </div>
                </form>
                <hr class="my-4">
                <button id="edit-group-modal-delete" class="w-full py-3 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition">グループを削除</button>
            </div>
        </div>

        <!-- ★ 変更：カレンダーイベント 追加・編集モーダル -->
        <div id="calendar-event-modal" class="fixed inset-0 bg-black/60 z-40 items-center justify-center p-4 hidden">
            <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm">
                <h3 id="calendar-event-modal-date" class="text-xl font-bold mb-4 text-center"></h3>
                
                <!-- ★ 変更: 既存のイベントリストから削除ボタンを削除 (画像1の要望) -->
                <div id="calendar-event-list" class="space-y-2 mb-4 max-h-32 overflow-y-auto">
                    <!-- JSで生成されます -->
                </div>

                <hr class="mb-4">
                
                <!-- 新規追加・編集フォーム -->
                <h4 id="calendar-event-form-title" class="text-lg font-semibold mb-2 text-center">祈る相手を追加</h4>
                <form id="calendar-event-form">
                    <div class="mb-3">
                        <label for="calendar-event-name" class="block text-sm font-medium text-gray-700 mb-1">名前</label>
                        <input type="text" id="calendar-event-name" placeholder="名前" class="w-full p-2 border rounded-lg" required>
                    </div>
                    <div class="mb-4">
                        <label for="calendar-event-requests" class="block text-sm font-medium text-gray-700 mb-1">祈祷課題</label>
                        <textarea id="calendar-event-requests" class="w-full h-24 p-2 border rounded-lg" placeholder="祈祷課題..."></textarea>
                    </div>
                    
                    <!-- ★ 変更: 開始日・終了日入力欄 (要望2, 3) -->
                    <div class="mb-3">
                        <label for="calendar-event-start-date" class="block text-sm font-medium text-gray-700 mb-1">開始日</label>
                        <input type="date" id="calendar-event-start-date" class="w-full p-2 border rounded-lg">
                    </div>
                    <div class="mb-4">
                        <label for="calendar-event-end-date" class="block text-sm font-medium text-gray-700 mb-1">終了日</label>
                        <input type="date" id="calendar-event-end-date" class="w-full p-2 border rounded-lg">
                    </div>
                    <!-- ★ 変更ここまで -->


                    <!-- ★ 変更: ボタンテキストを固定 (画像2の要望) -->
                    <button type="submit" id="calendar-event-submit-button" class="w-full py-3 bg-blue-500 text-white rounded-lg mb-2">祈る相手を追加</button>
                    <button type="button" id="calendar-event-modal-close" class="w-full py-3 bg-gray-200 rounded-lg">キャンセル</button>
                </form>
            </div>
        </div>

        <!-- ★ 追加：年/月 選択モーダル -->
        <div id="month-year-picker-modal" class="fixed inset-0 bg-black/60 z-50 items-center justify-center p-4 hidden">
            <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm">
                <!-- 年選択ヘッダー -->
                <div class="flex justify-between items-center mb-4">
                    <button id="picker-prev-year" class="p-2 rounded-full hover:bg-gray-100 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                    </button>
                    <h2 id="picker-year" class="text-xl font-bold"></h2>
                    <button id="picker-next-year" class="p-2 rounded-full hover:bg-gray-100 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                    </button>
                </div>
                <!-- 月選択グリッド -->
                <div id="month-picker-grid" class="month-picker-grid">
                    <!-- JSで生成されます -->
                </div>
                <button type="button" id="month-year-picker-close" class="w-full py-3 bg-gray-200 rounded-lg mt-4">キャンセル</button>
            </div>
        </div>


        <!-- ★ 追加：カスタムアラート・確認モーダル -->
        <div id="custom-modal" class="fixed inset-0 bg-black/60 z-50 items-center justify-center p-4 hidden">
            <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm">
                <h3 id="custom-modal-title" class="text-xl font-bold mb-4 text-center"></h3>
                <p id="custom-modal-message" class="text-center mb-6"></p>
                <div id="custom-modal-buttons" class="flex gap-2">
                    <!-- Buttons will be injected here -->
                </div>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let prayerDays = [];
            let groups = [];
            let settings = { startDate: new Date().toISOString().split('T')[0], cyclePeriod: 14 };
            let swipedItem = null;
            
            let calendarPrayers = [];
            let currentCalendarDate = new Date(); // カレンダーの現在表示月
            let selectedDateString = null; // ★ カレンダーで選択した「開始日」を保持
            
            // ★ 追加: 年/月ピッカーで選択中の年
            let pickerYear = new Date().getFullYear(); 

            const DATA_STORAGE_KEY = 'prayerApp_data_v10'; 

            function loadData() {
                const savedData = localStorage.getItem(DATA_STORAGE_KEY);
                if (savedData) {
                    const data = JSON.parse(savedData);
                    prayerDays = data.prayerDays || [];
                    groups = data.groups || [];
                    settings = data.settings || settings;
                    calendarPrayers = data.calendarPrayers || []; 
                }
                
                let dataMigrated = false;
                calendarPrayers.forEach(item => {
                    if (item.date && !item.startDate) {
                        item.startDate = item.date;
                        item.endDate = item.date; 
                        delete item.date;
                        dataMigrated = true;
                    }
                });
                if (dataMigrated) {
                    console.log("Data structure migrated.");
                    saveData(); 
                }

                if (groups.length === 0 || !groups.find(g => g.id === 'unassigned')) {
                    if (!groups.find(g => g.id === 'unassigned')) {
                        groups.unshift({ id: 'unassigned', name: '未分類' });
                    }
                }
                while (prayerDays.length < settings.cyclePeriod) prayerDays.push([]);
                prayerDays.length = settings.cyclePeriod;
            }

            function saveData() {
                localStorage.setItem(DATA_STORAGE_KEY, JSON.stringify({ prayerDays, groups, settings, calendarPrayers }));
            }

            // Element declarations
            const mainApp = document.getElementById('main-app');
            const screens = document.querySelectorAll('.screen');
            const headerTitle = document.getElementById('header-title');
            const dateElement = document.getElementById('current-date');
            const prayerListContainer = document.getElementById('prayer-list-container');
            const allPeopleList = document.getElementById('all-people-list');
            const prayCycleList = document.getElementById('pray-cycle-list');
            const searchInput = document.getElementById('search-input');
            const startDateInput = document.getElementById('start-date-input');
            const cyclePeriodInput = document.getElementById('cycle-period-input');
            const saveSettingsButton = document.getElementById('save-settings-button');
            const menuButton = document.getElementById('menu-button');
            const menuDrawer = document.getElementById('menu-drawer');
            const menuOverlay = document.getElementById('menu-overlay');
            const menuItems = document.querySelectorAll('.menu-item');
            
            const personModal = document.getElementById('person-modal');
            const personModalNameInput = document.getElementById('person-modal-name-input'); 
            const personModalGroup = document.getElementById('person-modal-group');
            const personModalRequests = document.getElementById('person-modal-requests');
            const personModalSave = document.getElementById('person-modal-save');
            const personModalClose = document.getElementById('person-modal-close');
            
            const fabContainer = document.getElementById('fab-container');
            const addPersonFab = document.getElementById('add-person-fab');
            const addGroupFab = document.getElementById('add-group-fab');
            const addPersonModal = document.getElementById('add-person-modal');
            const addGroupModal = document.getElementById('add-group-modal');
            const addPersonModalForm = document.getElementById('add-person-modal-form');
            const addGroupModalForm = document.getElementById('add-group-modal-form');
            const newPersonModalName = document.getElementById('new-person-modal-name');
            const newPersonModalGroup = document.getElementById('new-person-modal-group');
            const newPersonModalRequests = document.getElementById('new-person-modal-requests');
            const newGroupModalInput = document.getElementById('new-group-modal-input');
            const addPersonModalClose = document.getElementById('add-person-modal-close');
            const addGroupModalClose = document.getElementById('add-group-modal-close');

            const editGroupModal = document.getElementById('edit-group-modal');
            const editGroupModalForm = document.getElementById('edit-group-modal-form');
            const editGroupModalInput = document.getElementById('edit-group-modal-input');
            const editGroupModalClose = document.getElementById('edit-group-modal-close');
            const editGroupModalDelete = document.getElementById('edit-group-modal-delete');

            const customModal = document.getElementById('custom-modal');
            const customModalTitle = document.getElementById('custom-modal-title');
            const customModalMessage = document.getElementById('custom-modal-message');
            const customModalButtons = document.getElementById('custom-modal-buttons');

            const calendarScreen = document.getElementById('calendar-screen');
            const calendarMonthYear = document.getElementById('calendar-month-year');
            const prevMonthButton = document.getElementById('prev-month-button');
            const nextMonthButton = document.getElementById('next-month-button');
            const calendarGrid = document.getElementById('calendar-grid');
            const calendarEventModal = document.getElementById('calendar-event-modal');
            const calendarEventModalDate = document.getElementById('calendar-event-modal-date');
            const calendarEventList = document.getElementById('calendar-event-list');
            const calendarEventForm = document.getElementById('calendar-event-form');
            const calendarEventName = document.getElementById('calendar-event-name');
            const calendarEventRequests = document.getElementById('calendar-event-requests');
            // ★ 変更: 開始日・終了日の要素を取得
            const calendarEventStartDate = document.getElementById('calendar-event-start-date');
            const calendarEventEndDate = document.getElementById('calendar-event-end-date');
            const calendarEventSubmitButton = document.getElementById('calendar-event-submit-button');
            const calendarEventModalClose = document.getElementById('calendar-event-modal-close');
            
            // ★ 削除: calendarSearchInput
            // const calendarSearchInput = document.getElementById('calendar-search-input');
            const calendarMonthlyList = document.getElementById('calendar-monthly-list');
            
            // ★ 追加: 年/月ピッカーの要素
            const monthYearPickerModal = document.getElementById('month-year-picker-modal');
            const pickerYearEl = document.getElementById('picker-year');
            const pickerPrevYear = document.getElementById('picker-prev-year');
            const pickerNextYear = document.getElementById('picker-next-year');
            const monthPickerGrid = document.getElementById('month-picker-grid');
            const monthYearPickerClose = document.getElementById('month-year-picker-close');


            // --- ★ 追加：カスタムアラート・確認関数 ---
            function showCustomAlert(message, title = 'お知らせ') {
                document.body.appendChild(customModal);
                customModalTitle.textContent = title;
                customModalMessage.textContent = message;
                customModalButtons.innerHTML = `
                    <button id="custom-modal-ok" class="w-full py-3 bg-blue-500 text-white rounded-lg">OK</button>
                `;
                customModal.style.display = 'flex';
                
                const okButton = document.getElementById('custom-modal-ok');
                okButton.onclick = () => {
                    customModal.style.display = 'none';
                };
            }

            function showCustomConfirm(message, title = '確認') {
                return new Promise((resolve) => {
                    document.body.appendChild(customModal);
                    customModalTitle.textContent = title;
                    customModalMessage.textContent = message;
                    customModalButtons.innerHTML = `
                        <button id="custom-modal-cancel" class="w-full py-3 bg-gray-200 rounded-lg">キャンセル</button>
                        <button id="custom-modal-confirm" class="w-full py-3 bg-red-500 text-white rounded-lg">OK</button>
                    `;
                    customModal.style.display = 'flex';

                    const confirmButton = document.getElementById('custom-modal-confirm');
                    const cancelButton = document.getElementById('custom-modal-cancel');

                    confirmButton.onclick = () => {
                        customModal.style.display = 'none';
                        resolve(true);
                    };
                    cancelButton.onclick = () => {
                        customModal.style.display = 'none';
                        resolve(false);
                    };
                });
            }
            // --- カスタムアラート・確認関数ここまで ---


            function showScreen(screenId) {
                screens.forEach(s => s.classList.add('hidden'));
                const targetScreen = document.getElementById(screenId);
                if (targetScreen) targetScreen.classList.remove('hidden');

                if (screenId === 'list-screen') {
                    fabContainer.classList.remove('hidden');
                } else {
                    fabContainer.classList.add('hidden');
                }

                if (screenId === 'calendar-screen') {
                    // ★ 削除: calendarSearchInput.value = ''; 
                    renderCalendar(currentCalendarDate);
                }

                const screenTitles = {'home-screen': "Praylist", 'list-screen': '祈りのリスト一覧', 'pray-cycle-screen': 'Pray Cycle', 'settings-screen': '設定', 'calendar-screen': 'Pray Calender'};
                headerTitle.textContent = screenTitles[screenId] || "Praylist";
                toggleMenu(true);
            }

            function toggleMenu(forceClose = false) {
                document.body.appendChild(menuDrawer);
                menuDrawer.classList.toggle('-translate-x-full', forceClose);
            }
            
            // ★ renderHomeScreenのロジック変更
            function renderHomeScreen() {
                const today = new Date();
                const startDate = new Date(settings.startDate);
                
                const options = { month: 'long', day: 'numeric', weekday: 'long' };
                dateElement.textContent = today.toLocaleDateString('ja-JP-u-ca-japanese', options);

                prayerListContainer.innerHTML = '';
                const totalPeople = prayerDays.flat().length;
                let hasCyclePrayers = false;

                // 1. サイクルの祈りを取得
                const todayUTC = Date.UTC(today.getFullYear(), today.getMonth(), today.getDate());
                const startUTC = Date.UTC(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
                const dayDifference = Math.floor((todayUTC - startUTC) / (1000 * 60 * 60 * 24));
                
                let peopleForToday = [];
                if (dayDifference >= 0 && totalPeople > 0) {
                    const todaysIndex = dayDifference % settings.cyclePeriod;
                    peopleForToday = prayerDays[todaysIndex] || [];
                }

                if (peopleForToday.length > 0) {
                    hasCyclePrayers = true;
                    peopleForToday.forEach(person => {
                        const container = document.createElement('div');
                        container.className = 'prayer-item prayer-item-cycle';
                        container.innerHTML = `
                            <div class="flex justify-between items-center p-4 cursor-pointer">
                                <span class="text-lg font-medium prayer-name">${person.name}</span>
                                <svg class="w-5 h-5 prayer-chevron transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                            </div>
                            <div class="requests-content px-4 pb-4">
                                <hr class="my-2"><p class="text-left text-gray-700 whitespace-pre-wrap">${person.requests || '祈祷課題はまだ登録されていません。'}</p>
                            </div>`;
                        container.querySelector('.flex').addEventListener('click', (e) => {
                            container.classList.toggle('expanded');
                            container.querySelector('svg').classList.toggle('rotate-180');
                        });
                        prayerListContainer.appendChild(container);
                    });
                }

                // 2. ★ カレンダーの祈りを取得 (範囲対応)
                const todayStr = today.toISOString().split('T')[0]; // YYYY-MM-DD
                // ★ 変更: 今日が startDate と endDate の間にある予定を取得
                const calendarEventsForToday = calendarPrayers.filter(p => todayStr >= p.startDate && todayStr <= p.endDate);

                if (calendarEventsForToday.length > 0 && hasCyclePrayers) {
                    const separator = document.createElement('hr');
                    separator.className = 'border-gray-300 my-4';
                    prayerListContainer.appendChild(separator);
                }

                calendarEventsForToday.forEach(event => {
                    const container = document.createElement('div');
                    container.className = 'prayer-item prayer-item-calendar';
                    container.innerHTML = `
                        <div class="flex justify-between items-center p-4 cursor-pointer">
                            <span class="text-lg font-medium prayer-name">${event.name}</span>
                            <svg class="w-5 h-5 prayer-chevron transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                        </div>
                        <div class="requests-content px-4 pb-4">
                            <hr class="my-2"><p class="text-left text-gray-700 whitespace-pre-wrap">${event.requests || '祈祷課題はまだ登録されていません。'}</p>
                        </div>`;
                    
                    container.querySelector('.flex').addEventListener('click', (e) => {
                        container.classList.toggle('expanded');
                        container.querySelector('svg').classList.toggle('rotate-180');
                    });
                    prayerListContainer.appendChild(container);
                });

                // 3. リストが空の場合の処理
                if (totalPeople === 0 && calendarEventsForToday.length === 0) {
                     prayerListContainer.innerHTML = '<p class="text-center text-gray-500">リストから祈る人を追加してください</p>';
                } else if (!hasCyclePrayers && calendarEventsForToday.length === 0) {
                    if (dayDifference < 0) {
                        prayerListContainer.innerHTML = `<p class="text-center text-gray-500">開始まであと ${-dayDifference} 日です</p>`;
                    } else {
                        prayerListContainer.innerHTML = '<p class="text-center text-gray-500">今日の対象者はいません</p>';
                    }
                }
            }
            
            function renderPrayCycleScreen() {
                prayCycleList.innerHTML = '';
                prayerDays.forEach((peopleOnDay, dayIndex) => {
                    const dayContainer = document.createElement('div');
                    dayContainer.dataset.dayIndex = dayIndex;
                    dayContainer.className = 'p-2 rounded-lg'; 
                    dayContainer.innerHTML = `<h3 class="text-md font-bold text-gray-600 mb-2 p-1 bg-gray-200 rounded">${dayIndex + 1}日目</h3>`;
                    const listForDay = document.createElement('div');
                    listForDay.className = 'space-y-2 min-h-[20px]'; 

                    if (peopleOnDay.length > 0) {
                        peopleOnDay.forEach(person => createPersonListItem(person, dayIndex, listForDay, true, true)); // Enable drag
                    }

                    dayContainer.appendChild(listForDay);
                    prayCycleList.appendChild(dayContainer);
                    
                    handleDrop(dayContainer);
                });
            }

            // ★ 変更: renderAllPeopleList (グループの折りたたみ機能追加)
            function renderAllPeopleList() {
                allPeopleList.innerHTML = '';
                swipedItem = null;
                const searchTerm = searchInput.value.trim().toLowerCase();
                const allPeople = prayerDays.flat();

                if (searchTerm) {
                    const filteredPeople = allPeople.filter(p => p.name.toLowerCase().includes(searchTerm) || (p.requests && p.requests.toLowerCase().includes(searchTerm)));
                    if (filteredPeople.length > 0) {
                        filteredPeople.forEach(person => createPersonListItem(person, null, allPeopleList, true, false));
                    } else {
                        allPeopleList.innerHTML = '<p class="text-center text-gray-500">検索結果が見つかりません。</p>';
                    }
                } else {
                    groups.forEach(group => {
                        const peopleInGroup = allPeople.filter(p => p.groupId === group.id);
                        if(peopleInGroup.length === 0 && group.id === 'unassigned' && groups.length > 1) return;

                        const groupContainer = document.createElement('div');
                        
                        // ★ 変更: グループヘッダーの構造 (編集ボタンと折りたたみのため)
                        const groupHeader = document.createElement('div');
                        groupHeader.className = 'group-header flex justify-between items-center text-md font-bold text-gray-600 mb-2 p-1 bg-gray-200 rounded';

                        // --- ★ 修正: グループ名エリア（左側） ---
                        const groupNameClickableArea = document.createElement('span');
                        groupNameClickableArea.className = 'group-name-clickable flex-grow p-1 cursor-pointer flex items-center'; 
                        
                        const groupNameSpan = document.createElement('span');
                        groupNameSpan.textContent = group.name;
                        groupNameClickableArea.appendChild(groupNameSpan);

                        groupHeader.appendChild(groupNameClickableArea);

                        // --- ★ 修正: ボタンラッパー（右側） ---
                        const buttonsWrapper = document.createElement('span');
                        buttonsWrapper.className = 'flex items-center flex-shrink-0'; // 縮まないように設定

                        let editGroupButton = null;
                        if (group.id !== 'unassigned') {
                            editGroupButton = document.createElement('button');
                            editGroupButton.className = 'p-1 text-blue-600 hover:text-blue-800 flex-shrink-0';
                            editGroupButton.title = 'グループ名を編集';
                            editGroupButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                                              <path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536L16.732 3.732z" />
                                                            </svg>`;
                            
                            // ★ 修正: 編集ボタンをラッパーに追加
                            buttonsWrapper.appendChild(editGroupButton);
                        }
                        
                        // ★ 修正: Chevron(△)アイコンをラッパーに追加
                        const chevronIcon = document.createElement('span');
                        chevronIcon.className = "p-1 cursor-pointer"; // クリック領域
                        chevronIcon.innerHTML = `
                            <svg class="group-chevron w-5 h-5 transition-transform text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                            </svg>
                        `;
                        buttonsWrapper.appendChild(chevronIcon);

                        // ★ 修正: ボタンラッパーをヘッダーに追加
                        groupHeader.appendChild(buttonsWrapper);
                        // ★ 修正ここまで

                        groupContainer.appendChild(groupHeader); // groupHeader を先に追加

                        // ★ 変更: リストコンテナに折りたたみ用のクラスを追加
                        const listInGroup = document.createElement('div');
                        listInGroup.className = 'space-y-2 group-people-list'; // ★ クラス変更

                        if (peopleInGroup.length > 0) {
                            peopleInGroup.forEach(person => createPersonListItem(person, null, listInGroup, true, false));
                        }
                        groupContainer.appendChild(listInGroup);
                        allPeopleList.appendChild(groupContainer);
                        
                        // ★ 変更: 折りたたみイベントのターゲットを変更
                        const toggleCollapse = () => {
                            groupHeader.classList.toggle('expanded');
                        };
                        groupNameClickableArea.onclick = toggleCollapse; // グループ名エリア
                        chevronIcon.onclick = toggleCollapse; // Chevron(△)エリア

                        // ★ 修正: 編集ボタンのクリックイベント
                        if (editGroupButton) {
                            editGroupButton.onclick = (e) => {
                                e.stopPropagation(); // toggleCollapse を発火させない
                                openEditGroupModal(group.id);
                            };
                        }
                        
                        // ★ 追加: デフォルトで「未分類」は展開、他は折りたたむ
                        if (group.id === 'unassigned') {
                            groupHeader.classList.add('expanded');
                        }
                    });
                }
            }

            // ★ 修正: createPersonListItem
            function createPersonListItem(person, dayIndex, container, isInteractive, isDraggable = false) {
                const wrapper = document.createElement('div');
                wrapper.className = 'relative rounded-lg shadow-sm overflow-hidden';
                
                const content = document.createElement('div');
                // ★ 変更: スタイルを prayer-item に
                content.className = 'w-full prayer-item prayer-item-cycle list-item-content';
                
                // ★ 変更: HTML に編集ボタンと祈祷課題エリアを追加
                content.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div class="prayer-name-area flex-grow cursor-pointer p-4"> <!-- Clickable area for expansion -->
                            <span class="text-lg prayer-name">${person.name}</span>
                        </div>
                        <button class="edit-person-button p-4 text-blue-600 hover:text-blue-800" title="編集">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536L16.732 3.732z" />
                            </svg>
                        </button>
                    </div>
                    <div class="requests-content px-4 pb-4">
                        <hr class="my-2"><p class="text-left text-gray-700 whitespace-pre-wrap">${person.requests || '祈祷課題はまだ登録されていません。'}</p>
                    </div>
                `;

                if (isInteractive) {
                    const actionBg = document.createElement('div');
                    actionBg.className = 'absolute inset-y-0 right-0 w-24 bg-red-500 flex items-center justify-center';
                    const deleteButton = document.createElement('button');
                    deleteButton.className = 'text-white font-bold';
                    deleteButton.textContent = '削除';
                    actionBg.appendChild(deleteButton);
                    
                    wrapper.appendChild(actionBg); 
                    wrapper.appendChild(content); 

                    // ★ 変更: クリックイベントの割り当て
                    const editButton = content.querySelector('.edit-person-button');
                    
                    editButton.addEventListener('click', (e) => {
                        e.stopPropagation(); // スワイプハンドラへの伝播を防ぐ
                        if (!isSwiping) { // スワイプ中でないことを確認
                            openPersonModal(person.id);
                        }
                    });

                    // ★ 変更: 展開/折りたたみロジックを onClickCallback として渡す
                    const expansionClick = () => {
                        content.classList.toggle('expanded');
                    };
                    
                    handleSwipe(content, person.id, 
                        expansionClick, // ★ 変更: タップ時の動作
                        () => deletePerson(person.id)
                    );

                } else {
                    wrapper.appendChild(content);
                }

                 if (isDraggable) {
                    wrapper.draggable = true;
                    wrapper.dataset.personId = person.id;
                    wrapper.dataset.fromDay = dayIndex;
                    handleDrag(wrapper);
                }

                container.appendChild(wrapper);
            }
            
            function renderSettingsScreen() {
                startDateInput.value = settings.startDate;
                cyclePeriodInput.value = settings.cyclePeriod;
            }

            function openPersonModal(personId) {
                if (isSwiping) return;
                const person = prayerDays.flat().find(p => p.id === personId);
                if (!person) return;
                
                document.body.appendChild(personModal);
                personModal.style.display = 'flex';
                
                personModalNameInput.value = person.name; 
                personModalRequests.value = person.requests || '';

                personModalGroup.innerHTML = '';
                groups.forEach(group => {
                    const option = document.createElement('option');
                    option.value = group.id;
                    option.textContent = group.name;
                    if (group.id === person.groupId) option.selected = true;
                    personModalGroup.appendChild(option);
                });
                
                personModalSave.onclick = () => {
                    const newName = personModalNameInput.value.trim();
                    if (!newName) {
                        showCustomAlert('名前を入力してください。', 'エラー'); 
                        return;
                    }

                    person.name = newName; 
                    person.requests = personModalRequests.value.trim();
                    person.groupId = personModalGroup.value;
                    
                    saveData();
                    renderAllPeopleList(); 
                    renderHomeScreen(); 
                    renderPrayCycleScreen(); 
                    closePersonModal();
                };
            }
            function closePersonModal() { personModal.style.display = 'none'; }
            
            function openEditGroupModal(groupId) {
                const group = groups.find(g => g.id === groupId);
                if (!group || group.id === 'unassigned') return;

                document.body.appendChild(editGroupModal);
                editGroupModal.style.display = 'flex';
                editGroupModalInput.value = group.name;

                editGroupModalForm.onsubmit = null;
                editGroupModalDelete.onclick = null;

                editGroupModalForm.onsubmit = (e) => {
                    e.preventDefault();
                    const newName = editGroupModalInput.value.trim();
                    if (newName && newName !== group.name) {
                        if (groups.some(g => g.name === newName && g.id !== groupId)) {
                            showCustomAlert('そのグループ名は既に使用されています。', 'エラー');
                            return;
                        }
                        group.name = newName;
                        saveData();
                        renderAllPeopleList();
                        editGroupModal.style.display = 'none';
                    } else if (!newName) {
                         showCustomAlert('グループ名を入力してください。', 'エラー');
                    } else {
                         editGroupModal.style.display = 'none';
                    }
                };

                editGroupModalDelete.onclick = () => deleteGroup(groupId);
            }


            function addPerson(name, groupId, requests) { 
                let minLength = Infinity;
                let targetDayIndex = 0;
                for (let i = 0; i < prayerDays.length; i++) {
                    if (prayerDays[i].length < minLength) {
                        minLength = prayerDays[i].length;
                        targetDayIndex = i;
                    }
                }
                prayerDays[targetDayIndex].push({ 
                    id: Date.now(), 
                    name: name, 
                    requests: requests, 
                    groupId: groupId 
                });
                saveData();
            }

            async function deletePerson(personId) {
                 if (await showCustomConfirm(`「${prayerDays.flat().find(p => p.id === personId)?.name || ''}」さんをリストから削除しますか？`, '削除の確認')) {
                    let found = false;
                    for (let i = 0; i < prayerDays.length; i++) {
                        const initialLength = prayerDays[i].length;
                        prayerDays[i] = prayerDays[i].filter(p => p.id !== personId);
                        if (prayerDays[i].length < initialLength) {
                            found = true;
                            break;
                        }
                    }
                    if (found) {
                        saveData();
                        renderAllPeopleList();
                        renderPrayCycleScreen();
                        renderHomeScreen();
                    }
                }
            }
            
            // ★ 追加: 日付フォーマット用ヘルパー
            function formatDateStr(dateStr, showMonth = true) {
                const date = new Date(dateStr + 'T00:00:00');
                const month = date.getMonth() + 1;
                const day = date.getDate();
                return showMonth ? `${month}月${day}日` : `${day}日`;
            }
            
            // ★ 追加: タイムゾーンずれ補正のためのヘルパー
            // '2025-10-21' -> Date(2025, 9, 21)
            function parseDateStr(dateStr) {
                const [year, month, day] = dateStr.split('-').map(Number);
                return new Date(year, month - 1, day);
            }
            // Date() -> '2025-10-21'
            function formatDateObj(dateObj) {
                const year = dateObj.getFullYear();
                const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                const day = String(dateObj.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            // ★ 変更：カレンダー関連の関数 (範囲選択ロジックを変更) ---
            function renderCalendar(date) {
                calendarGrid.innerHTML = '';
                calendarMonthlyList.innerHTML = ''; 
                const year = date.getFullYear();
                const month = date.getMonth(); // 0-11
                
                calendarMonthYear.textContent = `${year}年 ${month + 1}月`;
                
                const firstDayOfMonth = new Date(year, month, 1).getDay(); // 0:Sun, 1:Mon ...
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const todayStr = formatDateObj(new Date()); // ★ 修正: formatDateObj を使用

                // ★ 削除: searchFilter
                // const searchFilter = calendarSearchInput.value.toLowerCase();
                const firstDateStr = `${year}-${String(month + 1).padStart(2, '0')}-01`;
                const lastDateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(daysInMonth).padStart(2, '0')}`;

                // ★ 変更: eventsThisMonth の取得ロジック (範囲対応)
                const eventsThisMonth = calendarPrayers
                    .filter(event => event.startDate <= lastDateStr && event.endDate >= firstDateStr) // 月に少しでもかかっていればOK
                    // ★ 削除: 検索フィルタ
                    /*
                    .filter(event => { 
                        if (!searchFilter) return true;
                        return event.name.toLowerCase().includes(searchFilter) ||
                               (event.requests && event.requests.toLowerCase().includes(searchFilter));
                    })
                    */
                    .sort((a, b) => a.startDate.localeCompare(b.startDate)); // ★ 開始日でソート

                // ★ 変更: マーカー用の全イベント日 (範囲対応)
                const allEventDates = new Set();
                calendarPrayers.forEach(event => {
                    // ★ 修正: タイムゾーンずれ補正 (parseDateStr を使用)
                    let currentDate = parseDateStr(event.startDate);
                    const endDate = parseDateStr(event.endDate);
                    
                    while(currentDate <= endDate) {
                        // ★ 修正: タイムゾーンずれ補正 (formatDateObj を使用)
                        const dateStr = formatDateObj(currentDate);

                        if (dateStr >= firstDateStr && dateStr <= lastDateStr) {
                             allEventDates.add(dateStr);
                        }
                        currentDate.setDate(currentDate.getDate() + 1);
                    }
                });


                // 1. 前月の日付（ダミー）
                for (let i = 0; i < firstDayOfMonth; i++) {
                    const dayEl = document.createElement('div');
                    dayEl.className = 'calendar-day other-month';
                    calendarGrid.appendChild(dayEl);
                }

                // 2. 今月の日付
                for (let i = 1; i <= daysInMonth; i++) {
                    const dayEl = document.createElement('div');
                    dayEl.className = 'calendar-day';
                    dayEl.textContent = i;
                    const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                    dayEl.dataset.date = dateString;
                    
                    if (dateString === todayStr) dayEl.classList.add('today');
                    if (allEventDates.has(dateString)) dayEl.classList.add('has-event'); 

                    // ★ 変更: 範囲選択ハイライトを削除
                    
                    // ★ 変更: 1クリックでモーダルを開く (要望1)
                    dayEl.addEventListener('click', () => openCalendarEventModal(dateString, null));
                    calendarGrid.appendChild(dayEl);
                }

                // 3. ★ 月間一覧の描画 (範囲表示対応)
                if (eventsThisMonth.length === 0) {
                    // ★ 削除: searchFilter
                    const message = '今月の予定はありません。';
                    calendarMonthlyList.innerHTML = `<p class="text-center text-gray-500">${message}</p>`;
                } else {
                    eventsThisMonth.forEach(event => {
                        const wrapper = document.createElement('div');
                        wrapper.className = 'relative rounded-lg shadow-sm overflow-hidden';

                        const content = document.createElement('div');
                        // ★ 変更: スタイルを prayer-item に
                        content.className = 'w-full prayer-item prayer-item-calendar list-item-content'; 
                        
                        // ★ 変更: 日付表示ロジック (要望2)
                        let dateDisplay;
                        const startMonth = parseDateStr(event.startDate).getMonth(); // ★ 修正
                        const endMonth = parseDateStr(event.endDate).getMonth(); // ★ 修正
                        
                        // 月をまたぐか、同じ月か
                        const showMonthForStart = startMonth !== month;
                        const showMonthForEnd = endMonth !== month;

                        if (event.startDate === event.endDate) {
                            dateDisplay = formatDateStr(event.startDate, showMonthForStart);
                        } else {
                            // 範囲表示
                            dateDisplay = `${formatDateStr(event.startDate, showMonthForStart)} - ${formatDateStr(event.endDate, showMonthForEnd)}`;
                        }
                        
                        // ★ 変更: HTML に編集ボタンと祈祷課題エリアを追加
                        content.innerHTML = `
                            <div class="flex justify-between items-center">
                                <div class="prayer-name-area flex-grow cursor-pointer p-4"> <!-- Clickable area for expansion -->
                                    <span class="text-lg font-medium prayer-name">${dateDisplay}: ${event.name}</span>
                                </div>
                                <button class="edit-calendar-event-button p-4 text-yellow-600 hover:text-yellow-800" title="編集">
                                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                      <path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536L16.732 3.732z" />
                                    </svg>
                                </button>
                            </div>
                            <div class="requests-content px-4 pb-4">
                                <hr class="my-2"><p class="text-left text-gray-700 whitespace-pre-wrap">${event.requests || '祈祷課題はまだ登録されていません。'}</p>
                            </div>`;
                        
                        const actionBg = document.createElement('div');
                        actionBg.className = 'absolute inset-y-0 right-0 w-24 bg-red-500 flex items-center justify-center';
                        const deleteButton = document.createElement('button');
                        deleteButton.className = 'text-white font-bold';
                        deleteButton.textContent = '削除';
                        actionBg.appendChild(deleteButton);
                        
                        wrapper.appendChild(actionBg);
                        wrapper.appendChild(content);

                        // ★ 変更: クリックイベントの割り当て
                        const editButton = content.querySelector('.edit-calendar-event-button');
                        
                        editButton.addEventListener('click', (e) => {
                            e.stopPropagation(); // スワイプハンドラへの伝播を防ぐ
                            if (!isSwiping) { // スワイプ中でないことを確認
                                openCalendarEventModal(event.startDate, event.id);
                            }
                        });

                        // ★ 変更: 展開/折りたたみロジックを onClickCallback として渡す
                        const expansionClick = () => {
                            content.classList.toggle('expanded');
                        };

                        handleSwipe(content, event.id, 
                            expansionClick, // ★ 変更: タップ時の動作
                            () => deleteCalendarEvent(event.id)
                        );

                        calendarMonthlyList.appendChild(wrapper);
                    });
                }
            }


            // ★ 変更: openCalendarEventModal (要望2, 3)
            function openCalendarEventModal(dateString, eventId = null) {
                selectedDateString = dateString; // モーダルが開いている「開始日」を保持
                
                document.body.appendChild(calendarEventModal);
                calendarEventModal.style.display = 'flex';
                
                calendarEventForm.reset();
                calendarEventForm.dataset.editingId = eventId ? eventId : '';
                
                // ★ 日付表示 (単一の日付)
                const startDateObj = parseDateStr(selectedDateString); // ★ 修正
                const options = { month: 'long', day: 'numeric', weekday: 'short' };
                calendarEventModalDate.textContent = startDateObj.toLocaleDateString('ja-JP', options);

                // ★ 既存の予定リストを表示
                calendarEventList.style.display = 'block'; 
                renderCalendarEventList(selectedDateString);

                if (eventId) {
                    // 編集モード
                    const event = calendarPrayers.find(p => p.id === eventId);
                    if (event) {
                        document.getElementById('calendar-event-form-title').textContent = '祈りを編集';
                        calendarEventName.value = event.name;
                        calendarEventRequests.value = event.requests || '';
                        calendarEventStartDate.value = event.startDate; // ★ 変更: 開始日を設定
                        calendarEventEndDate.value = event.endDate; 
                        calendarEventSubmitButton.textContent = '保存';
                    }
                } else {
                    // 新規追加モード
                    document.getElementById('calendar-event-form-title').textContent = '祈る相手を追加';
                    calendarEventName.value = ''; 
                    calendarEventRequests.value = ''; 
                    calendarEventStartDate.value = selectedDateString; // ★ 変更: 開始日を設定
                    calendarEventEndDate.value = selectedDateString; 
                    calendarEventSubmitButton.textContent = '祈る相手を追加'; 
                }
            }

            // ★ 変更: renderCalendarEventList (削除ボタンのHTMLを削除) (要望3)
            function renderCalendarEventList(dateString) {
                calendarEventList.innerHTML = '';
                // ★ 変更: dateString が startDate と endDate の間にある予定を取得
                const eventsOnDay = calendarPrayers.filter(p => dateString >= p.startDate && dateString <= p.endDate);
                
                if (eventsOnDay.length === 0) {
                    calendarEventList.innerHTML = '<p class="text-sm text-center text-gray-500">この日の予定はありません</p>';
                    return;
                }

                eventsOnDay.forEach(event => {
                    const eventEl = document.createElement('div');
                    // ★ 変更: ゴミ箱ボタンを削除
                    eventEl.className = 'p-2 bg-gray-100 rounded';
                    eventEl.innerHTML = `
                        <div>
                            <p class="font-medium">${event.name}</p>
                            <p class="text-sm text-gray-600">${event.requests || '(詳細なし)'}</p>
                        </div>
                    `;
                    calendarEventList.appendChild(eventEl);
                });
            }

            async function deleteCalendarEvent(eventId) {
                calendarPrayers = calendarPrayers.filter(p => p.id !== eventId);
                saveData();
                
                if (calendarEventModal.style.display === 'flex') {
                    renderCalendarEventList(selectedDateString); 
                }
                
                renderCalendar(currentCalendarDate); 
                renderHomeScreen(); 
            }
            
            // ★ 追加: 年/月ピッカーを開く
            function openMonthYearPicker() {
                pickerYear = currentCalendarDate.getFullYear();
                const currentMonth = currentCalendarDate.getMonth(); // 0-11
                
                renderMonthPicker(pickerYear, currentMonth);
                document.body.appendChild(monthYearPickerModal);
                monthYearPickerModal.style.display = 'flex';
            }
            
            // ★ 追加: 年/月ピッカーを描画
            function renderMonthPicker(year, selectedMonth) {
                pickerYearEl.textContent = `${year}年`;
                monthPickerGrid.innerHTML = '';
                
                const months = ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];
                
                months.forEach((monthName, index) => {
                    const monthButton = document.createElement('button');
                    monthButton.className = 'month-picker-button';
                    monthButton.textContent = monthName;
                    monthButton.dataset.month = index; // 0-11
                    
                    if (index === selectedMonth && year === currentCalendarDate.getFullYear()) {
                        monthButton.classList.add('selected');
                    }
                    
                    monthButton.addEventListener('click', () => {
                        currentCalendarDate.setFullYear(pickerYear, index, 1);
                        renderCalendar(currentCalendarDate);
                        monthYearPickerModal.style.display = 'none';
                    });
                    
                    monthPickerGrid.appendChild(monthButton);
                });
            }
            
            // --- カレンダー関数ここまで ---

            
            async function deleteGroup(groupId) {
                const group = groups.find(g => g.id === groupId);
                if (!group || group.id === 'unassigned') return;

                if (await showCustomConfirm(`グループ「${group.name}」を削除しますか？\nこのグループのメンバーは「未分類」に移動します。`, 'グループ削除の確認')) {
                    groups = groups.filter(g => g.id !== groupId);

                    prayerDays.forEach(day => {
                        day.forEach(person => {
                            if (person.groupId === groupId) {
                                person.groupId = 'unassigned';
                            }
                        });
                    });

                    saveData();
                    renderAllPeopleList();
                    editGroupModal.style.display = 'none';
                }
            }

            let isSwiping = false;
            function handleSwipe(element, itemId, onClickCallback, onDeleteCallback) {
                let startX = 0, diff = 0;
                
                const deleteButton = element.previousElementSibling.querySelector('button');
                if(deleteButton) {
                    deleteButton.onclick = async () => {
                         if (await showCustomConfirm(`本当に削除しますか？`, '削除の確認')) {
                            onDeleteCallback(itemId);
                         }
                    };
                }

                element.addEventListener('touchstart', (e) => {
                    if (swipedItem && swipedItem !== element) swipedItem.classList.remove('swiped');
                    startX = e.touches[0].clientX;
                    isSwiping = false;
                    element.style.transition = 'none';
                }, { passive: true });
                element.addEventListener('touchmove', (e) => {
                    diff = e.touches[0].clientX - startX;
                    if (Math.abs(diff) > 10) isSwiping = true;
                    if (diff < 0 && diff > -120) element.style.transform = `translateX(${diff}px)`;
                }, { passive: true });
                element.addEventListener('touchend', () => {
                    element.style.transition = 'transform 0.3s ease-out';
                    if (diff < -50) {
                        element.classList.add('swiped');
                        swipedItem = element;
                    } else {
                        element.classList.remove('swiped');
                        swipedItem = null;
                    }
                    element.style.transform = '';
                    setTimeout(() => { isSwiping = false; }, 100);
                });
                
                // ★ 変更: クリックイベントを .prayer-name-area に設定
                const nameArea = element.querySelector('.prayer-name-area');
                if (nameArea) {
                    nameArea.addEventListener('click', () => { 
                        if (!isSwiping && !element.classList.contains('swiped')) {
                            onClickCallback(itemId); 
                        }
                    });
                }
            }

            // --- DRAG & DROP LOGIC ---
            function handleDrag(item) {
                item.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', JSON.stringify({
                        personId: item.dataset.personId,
                        fromDay: item.dataset.fromDay
                    }));
                    setTimeout(() => item.classList.add('dragging'), 0);
                });
                item.addEventListener('dragend', () => item.classList.remove('dragging'));
            }

            function handleDrop(dayContainer) {
                dayContainer.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dayContainer.classList.add('bg-blue-100');
                });
                dayContainer.addEventListener('dragleave', () => {
                    dayContainer.classList.remove('bg-blue-100');
                });
                dayContainer.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dayContainer.classList.remove('bg-blue-100');
                    const { personId, fromDay } = JSON.parse(e.dataTransfer.getData('text/plain'));
                    const toDay = parseInt(dayContainer.dataset.dayIndex);

                    if (fromDay !== toDay) {
                        const personToMove = prayerDays[fromDay].find(p => p.id == personId);
                        if(personToMove) {
                            prayerDays[fromDay] = prayerDays[fromDay].filter(p => p.id != personId);
                            prayerDays[toDay].push(personToMove);
                            saveData();
                            renderPrayCycleScreen();
                            renderHomeScreen();
                        }
                    }
                });
            }

            // --- Event Listeners Setup ---
            headerTitle.addEventListener('click', () => { renderHomeScreen(); showScreen('home-screen'); });
            menuButton.addEventListener('click', () => toggleMenu());
            menuOverlay.addEventListener('click', () => toggleMenu());
            menuItems.forEach(item => {
                item.addEventListener('click', (e) => { 
                    e.preventDefault(); 
                    const screenId = e.currentTarget.dataset.screen;
                    if(screenId === 'pray-cycle-screen') renderPrayCycleScreen();
                    if(screenId === 'list-screen') renderAllPeopleList();
                    
                    if(screenId === 'calendar-screen') {
                        // ★ 削除: calendarSearchInput.value = ''; 
                        renderCalendar(currentCalendarDate); 
                    }
                    showScreen(screenId); 
                });
            });

            addPersonFab.addEventListener('click', () => { 
                newPersonModalGroup.innerHTML = '';
                groups.forEach(group => {
                    const option = document.createElement('option');
                    option.value = group.id;
                    option.textContent = group.name;
                    if (group.id === 'unassigned') option.selected = true; 
                    newPersonModalGroup.appendChild(option);
                });

                document.body.appendChild(addPersonModal); 
                addPersonModal.style.display = 'flex'; 
            });
            addGroupFab.addEventListener('click', () => { document.body.appendChild(addGroupModal); addGroupModal.style.display = 'flex'; });
            addPersonModalClose.addEventListener('click', () => { addPersonModal.style.display = 'none'; });
            addGroupModalClose.addEventListener('click', () => { addGroupModal.style.display = 'none'; });
            editGroupModalClose.addEventListener('click', () => { editGroupModal.style.display = 'none'; });

            addPersonModalForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = newPersonModalName.value.trim();
                const groupId = newPersonModalGroup.value;
                const requests = newPersonModalRequests.value.trim();

                if (name) {
                    addPerson(name, groupId, requests); 
                    renderAllPeopleList();
                    
                    newPersonModalName.value = '';
                    newPersonModalRequests.value = '';
                    newPersonModalGroup.value = 'unassigned'; 

                    addPersonModal.style.display = 'none';
                } else {
                    showCustomAlert('名前は必須です。', '入力エラー');
                }
            });
            
            addGroupModalForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const groupName = newGroupModalInput.value.trim();
                if (groupName && !groups.some(g => g.name === groupName)) {
                    groups.push({ id: `group_${Date.now()}`, name: groupName });
                    saveData();
                    renderAllPeopleList();
                    newGroupModalInput.value = '';
                    addGroupModal.style.display = 'none';
                } else if (groups.some(g => g.name === groupName)) {
                    showCustomAlert('そのグループ名は既に使用されています。', 'エラー');
                } else {
                    showCustomAlert('グループ名を入力してください。', 'エラー');
                }
            });
            
            // ★ 追加: 年/月ピッカーのイベントリスナー
            calendarMonthYear.addEventListener('click', openMonthYearPicker);
            
            pickerPrevYear.addEventListener('click', () => {
                pickerYear--;
                renderMonthPicker(pickerYear, -1); // 選択中の月はないので -1
            });
            
            pickerNextYear.addEventListener('click', () => {
                pickerYear++;
                renderMonthPicker(pickerYear, -1); // 選択中の月はないので -1
            });
            
            monthYearPickerClose.addEventListener('click', () => {
                monthYearPickerModal.style.display = 'none';
            });
            // ★ 追加ここまで

            prevMonthButton.addEventListener('click', () => {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
                renderCalendar(currentCalendarDate);
            });
            nextMonthButton.addEventListener('click', () => {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
                renderCalendar(currentCalendarDate);
            });
            
            // ★ 変更: カレンダーモーダル閉じるボタン (日付選択リセット削除)
            calendarEventModalClose.addEventListener('click', () => {
                calendarEventModal.style.display = 'none';
                // 閉じるだけにし、カレンダーの再描画は行わない
            });
            
            // ★ 削除: calendarSearchInput イベントリスナー
            // calendarSearchInput.addEventListener('input', () => {
            //     renderCalendar(currentCalendarDate);
            // });

            // ★ 変更: カレンダーフォームの送信 (要望2)
            calendarEventForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = calendarEventName.value.trim();
                const requests = calendarEventRequests.value.trim();
                const editingId = e.currentTarget.dataset.editingId ? Number(e.currentTarget.dataset.editingId) : null; 
                
                // ★ 変更: 開始日をフォームから取得
                const startDate = calendarEventStartDate.value; 
                let endDate = calendarEventEndDate.value; 

                if (!endDate) {
                    endDate = startDate; // 終了日が空なら開始日と同じにする
                }

                if (name && startDate) {
                    
                    // ★ バリデーション (タイムゾーンずれ補正)
                    if (parseDateStr(endDate) < parseDateStr(startDate)) { // ★ 修正
                        showCustomAlert('終了日は開始日以降に設定してください。', '日付エラー');
                        return;
                    }

                    if (editingId) {
                        // 編集
                        const eventIndex = calendarPrayers.findIndex(p => p.id === editingId);
                        if (eventIndex > -1) {
                            calendarPrayers[eventIndex].name = name;
                            calendarPrayers[eventIndex].requests = requests;
                            calendarPrayers[eventIndex].startDate = startDate; // ★ 変更: フォームの値を常に使用
                            calendarPrayers[eventIndex].endDate = endDate;
                        }
                    } else {
                        // ★ 新規追加 (単一オブジェクト)
                        calendarPrayers.push({
                            id: Date.now(),
                            startDate: startDate, // ★ 変更: フォームの値を常に使用
                            endDate: endDate,
                            name: name,
                            requests: requests
                        });
                    }

                    saveData();
                    calendarEventForm.reset();
                    calendarEventForm.dataset.editingId = ''; 
                    
                    calendarEventModal.style.display = 'none';
                    
                    renderCalendar(currentCalendarDate); // カレンダーのドットと月間一覧を更新
                    renderHomeScreen(); // ホーム画面も更新

                } else if (!name) {
                    showCustomAlert('名前を入力してください。', '入力エラー');
                }
            });

            searchInput.addEventListener('input', renderAllPeopleList);

            saveSettingsButton.addEventListener('click', () => {
                const oldPeriod = settings.cyclePeriod;
                const newPeriod = parseInt(cyclePeriodInput.value) || 14;

                settings.startDate = startDateInput.value;
                settings.cyclePeriod = newPeriod;

                if (oldPeriod !== newPeriod) {
                    const allPeople = prayerDays.flat();
                    prayerDays = Array.from({ length: newPeriod }, () => []);
                    allPeople.forEach(person => {
                        let minLength = Infinity;
                        let targetDayIndex = 0;
                        for (let i = 0; i < prayerDays.length; i++) {
                            if (prayerDays[i].length < minLength) {
                                minLength = prayerDays[i].length;
                                targetDayIndex = i;
                            }
                        }
                        prayerDays[targetDayIndex].push(person);
                    });
                }
                
                saveData();
                showCustomAlert('設定を保存しました。');
                renderAllPeopleList();
                renderHomeScreen();
                showScreen('home-screen');
            });

            personModalClose.addEventListener('click', closePersonModal);
            
            // Initial Load
            loadData();
            renderHomeScreen();
            renderAllPeopleList();
            renderSettingsScreen();
        });
    </script>
</body>
</html>

